[TOC]

## 安装

### 两种模式

#### solo-server

In solo server mode, **the DB is embedded H2 and both web server and executor server** run in the same process. This should be useful if one just wants to try things out. It can also be used on small scale use cases.

web 和 executor在同一个进程中执行，适用于H2 DB。



#### two server mode

但是以上两种情况都不适用于分布式部署，1个web对应多executors。这个情况在3.0以上得以修复。



#### distributed

Azkaban3.0在原有的两种基础上加入新的运行模式： multiple executor mode：web和executor可以运行在不同的服务器上，DB使用mysql。

The multiple executor mode is for most serious production environment. Its DB should be backed by MySQL instances with master-slave set up. 

The web server and executor servers should ideally run in different hosts so that upgrading and maintenance shouldn’t affect users. 

This multiple host setup brings in robust and scalable aspect to Azkaban.



### 编译安装

```shell
# Build Azkaban
./gradlew build

# Clean the build
./gradlew clean

# Build and install distributions
./gradlew installDist

# Run tests
./gradlew test

# Build without running tests
./gradlew build -x test
```



### Getting started with the Multi Executor Server



#### set up database

- Install Mysql

  Installation of MySQL DB won’t be covered by these instructions, but you can access the instructions on [MySQL Documentation Site](https://dev.mysql.com/doc/).

- Set up Mysql

  > 1. create database for Azkaban.:
  >
  >    ```
  >    # Example database creation command, although the db name doesn't need to be 'azkaban'
  >    mysql> CREATE DATABASE azkaban;
  >    ```
  >
  > 2. create a mysql user for Azkaban. For example,:
  >
  >    ```
  >    # Example database creation command. The user name doesn't need to be 'azkaban'
  >    mysql> CREATE USER 'username'@'%' IDENTIFIED BY 'password';
  >    # give the user INSERT, SELECT, UPDATE, DELETE permission on all tables in the Azkaban db.
  >    mysql> GRANT SELECT,INSERT,UPDATE,DELETE ON azkaban.* to '<username>'@'%' WITH GRANT OPTION;
  >    ```
  >
  > 3. Mysql Packet Size may need to be re-configured. MySQL may have, by default, a ridiculously low allowable packet size. To increase it, you’ll need to have the property max_allowed_packet set to a higher number, say 1024M. To configure this in linux, open /etc/my.cnf. Somewhere after mysqld, add the following:
  >
  >    ```
  >    [mysqld]
  >    ...
  >    max_allowed_packet=1024M
  >    ```
  >
  >    To restart MySQL, you can run:
  >
  >    ```
  >    $ sudo /sbin/service mysqld restart
  >    ```

- Create the Azkaban Tables

  Run individual table creation scripts from [latest table statements](https://github.com/azkaban/azkaban/tree/master/azkaban-db/src/main/sql) on the MySQL instance to create your tables.

  Alternatively, run create-all-sql-<version>.sql generated by build process. The location is the file is at `/Users/latang/LNKDRepos/azkaban/azkaban-db/build/distributions/azkaban-db-<version>`, after you build azkaban-db module by

  ```
  cd azkaban-db; ../gradlew build installDist
  ```



#### set up executor server

我们只需要将打包的可执行文件复制到合适的地方，然后修改conf 目录下 `azkaban.properties`中的mysql 的配置即可完成最小配置

执行`./bin/start-exec.sh` 即可，执行技术之后我们发现文件夹下面多了一些文件，例如currentpid和executor.port，这个两个文件是和当前进程有关的，分别是进程ID 和 端口ID

```
-rw-r--r--    1 liuwenqiang  admin     6B  2  8 16:17 currentpid
drwxr-sr-x    2 liuwenqiang  admin    64B  2  8 16:17 executions
-rw-r--r--    1 liuwenqiang  admin     5B  2  8 16:17 executor.port
-rw-r--r--    1 liuwenqiang  admin    22K  2  8 17:14 executorServerLog__2021-02-08+16:17:18.out
```

多个executor只需要配置链接到同一个数据库就可以了，executor会自动注册到executor表，但是默认active为0,需要手动修改 active为1，也就是这个时候如果我们的Executor 启动成功的话，我们可以在executor表中看到它的注册信息，然后修改active字段，使其可以被使用



#### set up web server

我们只需要将打包的可执行文件复制到合适的地方，然后修改conf 目录下 `azkaban.properties`中的mysql 的配置即可完成最小配置

执行`./bin/start-web.sh`尝试启动，启动之后去8081 端口查看页面，但是我们发现日志里面有报错

````
2021/02/08 16:23:02.006 +0800 ERROR [PluginCheckerAndActionsLoader] [main] [Azkaban] plugin path plugins/triggers doesn't exist!
2021/02/08 16:23:02.047 +0800  INFO [AzkabanWebServer] [main] [Azkaban] Setting timezone to America/Los_Angeles
2021/02/08 16:23:02.047 +0800  INFO [AzkabanWebServer] [main] [Azkaban] Registering MBeans...
2021/02/08 16:23:02.051 +0800  INFO [MBeanRegistrationManager] [main] [Azkaban] Bean azkaban.jmx.JmxJettyServer registered.
2021/02/08 16:23:02.052 +0800  INFO [MBeanRegistrationManager] [main] [Azkaban] Bean azkaban.jmx.JmxTriggerManager registered.
2021/02/08 16:23:02.053 +0800  INFO [MBeanRegistrationManager] [main] [Azkaban] Bean azkaban.jmx.JmxExecutorManager registered.
2021/02/08 16:23:02.060 +0800  INFO [MBeanRegistrationManager] [main] [Azkaban] Bean org.apache.log4j.jmx.HierarchyDynamicMBean registered.
2021/02/08 16:23:02.060 +0800  INFO [AzkabanWebServer] [main] [Azkaban] ************* loginLoggerObjName is null, make sure there is a logger with name azkaban.webapp.servlet.LoginAbstractAzkabanServlet
2021/02/08 16:23:02.060 +0800  INFO [ExecutorManager] [main] [Azkaban] Initializing executors from database.
2021/02/08 16:23:02.062 +0800 ERROR [ExecutorManager] [main] [Azkaban] No active executors found
2021/02/08 16:23:02.062 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] Exception in thread "main"
2021/02/08 16:23:02.062 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] azkaban.executor.ExecutorManagerException: No active executors found
2021/02/08 16:23:02.062 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] 	at azkaban.executor.ActiveExecutors.setupExecutors(ActiveExecutors.java:52)
2021/02/08 16:23:02.062 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] 	at azkaban.executor.ExecutorManager.setupExecutors(ExecutorManager.java:174)
2021/02/08 16:23:02.062 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] 	at azkaban.executor.ExecutorManager.initialize(ExecutorManager.java:108)
2021/02/08 16:23:02.062 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] 	at azkaban.executor.ExecutorManager.start(ExecutorManager.java:122)
2021/02/08 16:23:02.062 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] 	at azkaban.webapp.AzkabanWebServer.prepareAndStartServer(AzkabanWebServer.java:495)
2021/02/08 16:23:02.063 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] 	at azkaban.webapp.AzkabanWebServer.launch(AzkabanWebServer.java:243)
2021/02/08 16:23:02.063 +0800 ERROR [StdOutErrRedirect] [main] [Azkaban] 	at azkaban.webapp.AzkabanWebServer.main(AzkabanWebServer.java:234)
````

主要分为两个，第一个是没有`plugin path plugins/triggers doesn't exis`，第二个是没有`No active executors found` 这里主要是没有可用的executors 引起的，我们只要去数据库将active 字段设置为1 即可

![image-20210208170632970](https://kingcall.oss-cn-hangzhou.aliyuncs.com/blog/img/image-20210208170632970.png)

这个时候再重新启动，就可以了

![image-20210208171036425](https://kingcall.oss-cn-hangzhou.aliyuncs.com/blog/img/image-20210208171036425.png)





### Set up Azkaban Plugins

- viewer plugins that enable custom web pages to add features to Azkaban. Some of the known implementations include HDFS filesystem viewer, and Reportal.
- trigger plugins that enable custom triggering methods.
- user manager plugin that enables custom user authentication methods. For instance, in LinkedIn we have LDAP based user authentication.
- alerter plugins that enable different alerting methods to users, in addition to email based alerting.
- pluggable job type executors on AzkabanExecutorServer, such as job types for hadoop ecosystem components.

#### User Manager Plugins

By default, Azkaban ships with the XMLUserManager class which authenticates users based on a xml file, which is located at `conf/azkaban-users.xml`.

This is not secure and doesn’t serve many users. In real production deployment, you should rely on your own user manager class that suits your need, such as a LDAP based one. 

The `XMLUserManager` can still be used for special user accounts and managing user roles. You can find examples of these two cases in the default `azkaban-users.xml` file.



```
<azkaban-users>
  <user groups="azkaban" password="azkaban" roles="admin" username="azkaban"/>
  <user password="metrics" roles="metrics" username="metrics"/>

  <role name="admin" permissions="ADMIN"/>
  <role name="metrics" permissions="METRICS"/>
</azkaban-users>
```

### Viewer Plugins

#### HDFS Viewer Plugin

HDFS Viewer Plugin should be installed in AzkabanWebServer plugins directory, which is specified in AzkabanWebServer’s config file, for example, in `Azkaban-web-server-install-dir/conf/azkaban.properties`:

```
viewer.plugins=hdfs
```

This tells Azkaban to load hdfs viewer plugin from `Azkaban-web-server-install-dir/plugins/viewer/hdfs`.

Extract the `azkaban-hdfs-viewer` archive to the AzkabanWebServer `./plugins/viewer` directory. Rename the directory to `hdfs`, as specified above.

Depending on if the hadoop installation is turned on:

1. If the Hadoop installation does not have security turned on, the default config is good enough. One can simply restart `AzkabanWebServer` and start using the HDFS viewer.
2. If the Hadoop installation does have security turned on, the following configs should be set differently than their default values, in plugin’s config file:

| Parameter                       | Description                                                  |
| ------------------------------- | ------------------------------------------------------------ |
| `azkaban.should.proxy`          | Whether Azkaban should proxy as another user to view the hdfs filesystem, rather than Azkaban itself, defaults to `true` |
| `hadoop.security.manager.class` | The security manager to be used, which handles talking to secure hadoop cluster, defaults to `azkaban.security.HadoopSecurity Manager_H_1_0` (for hadoop 1.x versions) |
| `proxy.user`                    | The Azkaban user configured with kerberos and hadoop. Similar to how oozie should be configured, for secure hadoop installations |
| `proxy.keytab.location`         | The location of the keytab file with which Azkaban can authenticate with Kerberos for the specified `proxy.user` |

For more Hadoop security related information, see [HadoopSecurityManager](https://azkaban.readthedocs.io/en/latest/plugins.html#hadoopsecuritymanager).

##### 升级hadoop 版本

HDFS Viewer Plugin 使用的实hadoop 2 的版本，对于想要升级新版本主要是包括一下步骤

1. 修改父模块下的build.gradle配置文件中hadoop 的版本，然后尝试打包，解决版本不匹配的问题，主要包括一下两块
   1. DistributedFileSystem 在hadoop2 中在hadoop-common 包中，在hadoop 3 中在hadoop-client 中
   2. org.apache.hadoop.fs.permission.AccessControlException 现在是 org.apache.hadoop.security.AccessControlException

![image-20210208202855575](https://kingcall.oss-cn-hangzhou.aliyuncs.com/blog/img/image-20210208202855575.png)



##### 配置

首先我们需要知道的是我们的插件里面是有这个配置的，你可以在编译源码之前进行配置，也可以在外部配置

![image-20210208221648592](https://kingcall.oss-cn-hangzhou.aliyuncs.com/blog/img/image-20210208221648592.png)



外部配置的话，就是`viewer/hdfs/conf/plugin.properties`，例如下面

```
viewer.name=HDFS
viewer.path=hdfs
viewer.order=1
viewer.hidden=false
viewer.external.classpaths=lib/
viewer.servlet.class=azkaban.viewer.hdfs.HdfsBrowserServlet
hadoop.security.manager.class=azkaban.security.HadoopSecurityManager_H_2_0
azkaban.should.proxy=false
proxy.user=azkaban
proxy.keytab.location=
allow.group.proxy=false
file.max.lines=1000
```

其他需要注意得问题就是依赖的问题，我们需要将相关的依赖放到`viewer/hdfs`的lib 目录下，例如azkaban-sccurity 和 hadoop 的相关依赖





#### Job Type Plugins

Azkaban has a limited set of built-in job types to run local unix commands and simple java programs. In most cases, you will want to install additional job type plugins, for example, hadoopJava, Pig, Hive, VoldemortBuildAndPush, etc. Some of the common ones are included in azkaban-jobtype archive. Here is how to install:

Job type plugins should be installed with AzkabanExecutorServer’s plugins directory, and specified in AzkabanExecutorServer’s config file. For example, in `Azkaban-exec-server-install-dir/conf/azkaban.properties`:

```
azkaban.jobtype.plugin.dir=plugins/jobtypes
```

This tells Azkaban to load all job types from `Azkaban-exec-server-install-dir/plugins/jobtypes`. Extract the archive into AzkabanExecutorServer `./plugins/` directory, rename it to `jobtypes` as specified above.

The following setting is often needed when you run Hadoop Jobs:

| Parameter                  | Description                                                  |
| -------------------------- | ------------------------------------------------------------ |
| `hadoop.home`              | Your `$HADOOP_HOME` setting.                                 |
| `jobtype.global.classpath` | The cluster specific hadoop resources, such as hadoop-core jar, and hadoop conf (e.g. `${hadoop.home}/hadoop-core-1.0. 4.jar,${hadoop.home}/conf`) |

Depending on if the hadoop installation is turned on:

- If the hadoop installation does not have security turned on, you can likely rely on the default settings.
- If the Hadoop installation does have kerberos authentication turned on, you need to fill out the following hadoop settings:

| Parameter                       | Description                                                  |
| ------------------------------- | ------------------------------------------------------------ |
| `hadoop.security.manager.class` | The security manager to be used, which handles talking to secure hadoop cluster, defaults to `azkaban.security.HadoopSecurity Manager_H_1_0` (for hadoop 1.x versions) |
| `proxy.user`                    | The Azkaban user configured with kerberos and hadoop. Similar to how oozie should be configured, for secure hadoop installations |
| `proxy.keytab.location`         | The location of the keytab file with which Azkaban can authenticate with Kerberos for the specified proxy.user |

For more Hadoop security related information, see [HadoopSecurityManager](https://azkaban.readthedocs.io/en/latest/plugins.html#hadoopsecuritymanager).

Finally, start the executor, watch for error messages and check executor server log. For job type plugins, the executor should do minimum testing and let you know if it is properly installed.



### 其他配置



#### 属性配置

Azkaban job is specified with a set of key-value pairs we call properties. There are multiple sources for deciding which properties will finally be a part of job execution. Following table lists out all the sources of properties and their priorities. Please note that if a property occur in multiple sources, then its value from high property source will be used

Following properties are visible to the users. These are the same properties which are merged to form `jobProps` in `AbstractProcessJob.java`



| PropertySource                                            | Description                                                  | Priority    |
| --------------------------------------------------------- | ------------------------------------------------------------ | ----------- |
| `global.properties` in `conf` directory                   | These are admin configured properties during Azkaban setup. Global to all jobtypes. | Lowest (0)  |
| `common.properties` in `jobtype` directory                | These are admin configured properties during Azkaban setup. Global to all jobtypes. | 1           |
| `plugin.properties`in `jobtype/<jobtype-name>`directory   | These are admin configured properties during Azkaban setup. Restricted to a specific jobtype. | 2           |
| `common.properties` in project zip                        | These are user specified property which apply to all jobs in sibling or descendent directories | 3           |
| Flow properties specified while triggering flow execution | These are user specified property. These can be specified from UI or Ajax call but cannot be saved in project zip. | 4           |
| `{job-name}.job` job specification                        | These are user specified property in actual job file         | Highest (5) |



####  Web Server Configurations

| Parameter         | Description                                                  | Default             |
| ----------------- | ------------------------------------------------------------ | ------------------- |
| azkaban.name      | The name of the azkaban instance that will show up in the UI. Useful if you run more than one Azkaban instance. | Local               |
| azkaban.label     | A label to describe the Azkaban instance.                    | My Local Azkaban    |
| azkaban.color     | Hex value that allows you to set a style color for the Azkaban UI. | #FF3601             |
| web.resource.dir  | Sets the directory for the ui’s css and javascript files.    | web/                |
| default.timezone  | The timezone that will be displayed by Azkaban.              | America/Los_Angeles |
| viewer.plugin.dir | Directory where viewer plugins are installed.                | plugins/viewer      |
| job.max.Xms       | The maximum initial amount of memory each job can request. This validation is performed at project upload time | 1GB                 |
| job.max.Xmx       | The maximum amount of memory each job can request. This validation is performed at project upload time | 2GB                 |
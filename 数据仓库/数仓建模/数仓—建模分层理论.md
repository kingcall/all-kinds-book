[toc]
### 分层建设理论
简单点儿，直接ODS+DM就可以了，将所有数据同步过来，然后直接开发些应用层的报表，这是最简单的了；当DM层的内容多了以后，想要重用，就会再拆分一个公共层出来，变成3层架构,这个过程有点类似代码重构，就是在实践中不断的进行抽象、总结

#### 分层的意义

##### 清晰数据结构
每一个数据分层都有它的作用域，这样在使用表的时候能更方便的定位和理解。

##### 数据血缘追踪
由于最终给业务呈现的是一个能直接使用的业务表，但是表的数据来源有很多，如果有一张来源表出问题了，我们希望能够**快速准确的定位到问题，并清楚他的危害范围和影响范围**。

##### 减少重复开发和资源浪费
- 规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算
- 清晰明了的结构使得开发、维护的成本降低
- 减少重复计算和存储的资源浪费

##### 复杂问题简单化
- 将一个复杂的任务分解成多个步骤来完成，每一层只处理单一的步骤，比较简单和容易理解。而且便于维护数据的准确性，当数据出现问题之后，可以不用修复所有的数据，只需要从有问题的步骤开始修复。

> 在实际的建设过程中，由于业务使用数据非常紧急以及统一数仓层建设跟不上业务的需要，所以DIM和ADS层可能直接使用ODS层进行快速的业务响应，但是这种不规范的操作可能导致数据口径不一致，**所以待数仓建设完毕，要切换到统一数仓层和DIM层**

#### ods
- ODS 全称是 OperationalDataStore，操作数据存储"面向主题的"，数据运营层，也叫ODS层，是最接近数据源中数据的一层，数据源中的数据，经过抽取、洗净、传输，也就说传说中的 ETL 之后，装入本层。
- 本层的数据，总体上大多是**按照源头业务系统的分类方式而分类的**。
> 但是，这一层面的数据却不等同于原始数据。在源数据装入这一层时，要进行诸如**去噪**(例如有一条数据中人的年龄是300岁，这种属于异常数据，就需要提前做一些处理)、去重(例如在个人资料表中，同一ID却有两条重复数据，在接入的时候需要做一步去重)、字段命名规范等一系列操作
- 这里的数据处理，并不涉及业务逻辑，仅仅是针对数据完整性以及重复值和空值的处理。

##### 设计规范
- 表名的设计 ODS_业务系统_表名，这样的设计可以保持与业务表名一致，又可以有清晰的层次，还可以区分来源。
- ods 层**不做字段名归一和字段类型统一的操作，如果需要使用兼容的数据类型**
- 对于增量表，需要设计增量表(ODS_业务系统_表名_delta)和全量表,然后将增量表合并成全量表数据
- 对于半结构化数据需要设计解析
- 由于业务数据库（OLTP）基本按照ER实体模型建模，因此ODS层中的建模方式也是**ER实体模型**

> ods 的设计可以保证所有的数据按照统一的规范进行存储。

#### 统一数仓层(DW)
- 是数据仓库的主体.在这里，从ODS层中获得的数据按照主题建立各种数据模型。
- 这一层和维度建模会有比较深的联系，业务数据是按照**业务流程方便操作的角度**来组织数据的，而统一数仓层是**按照业务易理解的角度**进行数据组织的。
- 定义了一致的指标、维度，各业务板块、数据域都是按照统一的规范来建设，从而形成统一规范的**标准业务数据体系**
- 它们通常都是基于Kimball的维度建模理论来构建的，**并通过一致性维度和数据总线来保证各个子主题的维度一致性**。

> 如果 ods 层的数据就非常规整，基本能满足我们绝大部分的需求，这当然是好的，这时候dwd层其实也没太大必要。但是现实中接触的情况是 ods 层的数据很难保证质量，毕竟数据的来源多种多样，推送方也会有自己的推送逻辑，在这种情况下，我们就需要通过额外的一层 dwd 来屏蔽一些底层的差异。

##### 设计原则
###### 一致性维度规范
- 公共层的维度表中相同维度属性在不同物理表中的字段名称、数据类型、数据内容必须保持一致

###### 维度的组合与拆分
- 将维度所描述业务相关性强的字段在一个物理维表实现。相关性强是指经常需要一起查询或进行报表展现、两个维度属性间是否存在天然的关系等。例如，商品基本属性和所属品牌。

##### DWD
- 公告明细数据层
- DWD层要做的就是将**数据清理、整合、规范化、脏数据、垃圾数据、规范不一致的、状态定义不一致的、命名不规范的数据都会被处理**。
- DWD层应该是覆盖所有系统的、完整的、干净的、具有一致性的数据层。在DWD层会根据维度模型，设计事实表和维度表，也就是说DWD层是一个非常规范的、高质量的、可信的数据明细层。

##### DWS
- DWS层为**公共汇总层**，会进行轻度汇总，粒度比明细数据稍粗，**基于DWD层上的基础数据，整合汇总成分析某一个主题域的服务数据**，一般是宽表。
- DWS层应覆盖80%的应用场景

#### DIM 层
- 维表层
- 稳定维度维表，渐变维度维表

##### 维度表
- **维度指的是观察事物的角度，提供某一业务过程事件涉及用什么过滤和分类的描述属性**，"谁、什么时候、什么地点、为什么、如何"干了什么，维度表示维度建模的基础和灵魂
- 比如，"小王早上在小卖部花费5元钱购买了包子"，时间维度——早上，地点维度——小卖部，商品维度——包子
- 维度表包含了业务过程记录的业务过程度量的上下文和环境。维度表都包含单一的主键列，**维度表设计的核心是确定维度字段，维度字段是查询约束条件(where)、分组条件(group)、排序(order)，与报表标签的基本来源**。
- 维度表通常比较宽**，包含多个属性、是扁平的规范表**，实际应用中包含几十个或者上百个属性的维度并不少见，维度表应该包括一些**有意义的描述**，方便下游使用
- 维度表的维度属性，应该尽可能的丰富，所以维度表中，经常出现一些反范式的设计，把维度属性并到主维度属性中，达到易用少关联的效果。
- 维度表的设计包括维度选择，主维表的确定，梳理关联维度，定义维度属性的过程
- 维度的选择一般从报表需求和从业务人员的交谈中发现，主要用于过滤、分组、排序
- 主维度表一般从业务库直接同步，比如用户表
- 关联维度主要是不同业务系统或者同一业务系统的表之间存在关联性(范式建模)，根据对业务表的梳理，确定哪些表和主维度表之间存在关联关系，并选择其中的某些表用于生成维度属性。

##### 渐变维度维表
- 维度数据会随着时间发生变化，变化速度非常缓慢。eg：电商平台的用户维度表，用户的收货地址是缓慢变化的。

#### 标签数据层(TDM)
- 面向对象建模，对跨业务板块、跨数据域的特定对象进行数据整合，通过统一的ID-Mapping 把各个业务板块，各个业务过程中**同一对象的数据打通**，形成对象的全域数据标签体系，方便深度分析、挖掘、应用。

##### 标签的分类
- 标签按照产生和计算方式的不同可分为属性标签，统计标签，算法标签，关联标签

###### 属性标签
- 对象本身的性质就是属性标签

###### 统计标签
- 对象在业务过程中产生的原子指标，通过不同的计算方法可以生成统计标签

###### 算法标签
- 对象在多个业务过程中的特征规律通过一定的算法产出的标签

###### 关联标签
- 对象在特定的业务过程会和其他对象关联，关联对象的标签也可以打在主对象上

##### 对象标识
- 对象的标识可以标识一个对象，一般是对象的ID,比如手机号，身份证，登录账号

##### 标签
- 利用原始数据，通过一定的逻辑加工产出直接能被业务所直接使用的、可阅读的，有价值的数据。

##### 标签类目
- 是标签的分类组织方式，是标签信息的一种结构化描述，目的是管理、查找，一般采用多级类目
- 一般当标签的个数超过50个的时候，业务人员查找标签就会变得非常麻烦，

##### ID-Mapping
> 一个自然人他有身份证号码进行唯一标识，但是在医保的时候他使用的实医保账号，缴纳水电费的时候又是不同的账号，使用手机的时候又是设备账号，上网的时候是网商账号。

在确认对象后，由于同一对象在不同的业务体系中的对象标识是不一样的，因此需要将同一对象上的不同ID  标识打通，以便所有的业务数据都能够在该对象上打通。

完成对象的ID 打通需要给对象设置一个超级ID,需要根据对象当前业务体系的ID和获取得到或者计算得到超级ID,进而完成所有业务标识的ID打通

一般来说ID 打通是建设标签体系的前提，如果没有ID打通就无法收集到一个对象的全面信息，也就无法对这个对象进行全面的标签刻画。

###### ID-Mapping 的计算
传统的计算方法要有 ID-ID 之间的两两关系，例如邮箱和手机号可以打通，手机号和身份证号可以打通，那么邮箱就和身份证号可以打通，但是当数据量非常大，且业务板块非常多的时候，例如有上一个对象，每个对象有数十种ID,这个时候打通就需要非常漫长的计算

#### ADS 层

数仓层，DIM 层，TDM 层是相对稳定的，所以无法满足灵活多变业务需求，所以这和数仓层的规范和划分相矛盾，所以我们在此基础上建立了另外一个层，这就是ADS 层，解决了规划稳定和灵活多变之间的矛盾。

数据应用层，按照业务的需要从统一数仓层和DIM进行取数，并面向业务的特殊需求对数据进行加工,以满足业务和性能的需求。

ADS 层因为面向的实众多的需求，所以这一层没有太多的规范，只需要按照命名规范来进行就可以了

##### ADS 层设计
ADS 层的建设是强业务推动的，业务部门需要参与到ADS 的建设中来

###### 实现流程
- 理清需求，了解业务方对数据内容、使用方式(怎么交互的，报表、接口、即席查询、在线查询、指标查询、搜索)、性能的要求
- 盘点现有的数仓表是否可以支持
- 代码实现，选择合适的存储引擎和查询引擎

###### 使用场景与性能
- 针对业务方的使用场景，我们需要设计出高效，满足要求的ADS 层表
- 如果是多维分析，为了减少连接，提升性能，我们一般采用大宽表设计，使用高性能引擎支撑
- 如果是特定指标查询，一般采用KV的形式组织
- 如果是搜索场景，一般采用搜索引擎

#### DM 层数据集市层

主要是提供数据产品和数据分析的数据，一般会存放在ES、Mysql、也可能直接存储在hive中或者druid供数据分析和数据挖掘使用。

主要**解决部门用户报表和分析需求**而建立数据库，数据集市就代表数据仓库的主题域
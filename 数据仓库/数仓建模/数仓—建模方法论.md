[toc]
## 建模方法论
> 数仓的建模或者分层，其实都是为了更好的去组织、管理、维护数据

1. **访问性能**：能够快速查询所需的数据，减少数据I/O。
1.** 数据成本**：减少不必要的数据冗余，实现计算结果数据复用，降低大数据系统中的存储成本和计算成本。
1. **使用效率**：改善用户应用体验，提高使用数据的效率。
1. **数据质量**：改善数据统计口径的不一致性，减少数据计算错误的可能性，提供高质量的、一致的数据访问平台。
> 需要注意的建模其实是和公司的业务、公司的数据量、公司使用的工具、公司数据的使用方式密不可分的

## 范式建模(关系型数据库)
- 范式建模法其实是我们在构建数据模型常用的一个方法，该方法的主要由Inmon所提倡，主要解决关系型数据库得数据存储，利用的一种技术层面上的方法，主要用于业务系统，**所以范式建模主要是利用关系型数据库进行数仓建设**
- 目前，我们在关系型数据库中的建模方法，大部分采用的是三范式建模法。
- 符合3NF要求的数据库设计，基本上解决了数据冗余过大，插入异常，修改异常，删除异常的问题。

### 三范式
#### 第一范式
- 属性值不可再分

#### 第二范式
- 要求每张表都要有一个主键，其它记录完全依赖主键。要求实体的属性**完全依赖于主关键字**。
> 例如，如果花名册里只有名字，没有学号，则重名的话会很麻烦。
- 所谓完全依赖是指不能存在仅依赖主关键字一部分的属性，如果存在，那么这个属性和主关键字的这一部分应该分离出来形成一个新的实体，新实体与原实体之间是一对多的关系。

#### 第三范式
- 所有字段只能依赖主键，不得依赖于其它字段(非主属性)。消除依赖传递。

### 范式建模的优缺点
#### 优点
- 节约存储(尤其是利用数据库进行数仓建设的时候)
- 规范化带来的好处是通过**减少数据冗余****提高更新数据的效率**，**同时保证数据完整性**。
- 结构清晰，易于理解

#### 缺点
- 构建比较复杂
- 查询复杂(需要很多的关联)
- 不适合在大数据环境下构建(1 查询复杂  2 存储很便宜) 
> 由于建模方法限定在关系型数据库之上，在某些时候反而限制了整个数据仓库模型的灵活性，性能等，特别是考虑到数据仓库的底层数据向数据集市的数据进行汇总时，需要进行一定的变通才能满足相应的需求。

### 为什么还要学习范式建模
- 上游数据源往往是业务数据库，而这些业务数据库采用的实范式建模，所以了解范式建模可以帮助我们去合理的建设数仓
> 如果了解范式建模，从er 模型可以了解到数据架构，例如一个电商系统，从er模型就可以知道哪些涉及到商品的管理、用户的管理、订单管理，拿到这些关系之后，我们就可以更好的进行数仓管理与建设
- 数据源的规范定义需要我们了解范式理论，可以更好的和业务系统进行对接
- 数仓的稀有系统，如报表系统设计的时候也会使用到范式建模

## ER实体建模
- 将事务抽象为"实体"（Entity）、"属性"（Property）、"关系"（Relationship）来**表示数据关联和事物描述**，这种**对数据的抽象建模**通常被称为ER实体关系模型。
- 实体建模法并不是数据仓库建模中常见的一个方法，它来源于哲学的一个流派。
- 从哲学的意义上说，客观世界应该是可以细分的，客观世界应该可以分成由一个个实 体，以及实体与实体之间的关系组成。我们在数据仓库的建模过程中完全可以引入这个抽象的方法，**将整个业务也可以划分成一个个的实体，而每个实体之间的 关系，以及针对这些关系的说明就是我们数据建模需要做的工作**。
-
> 在日常建模中，"实体"用矩形表示，"关系"用菱形，"属性"用椭圆形。ER实体关系模型也称为E-R关系图

> 虽然实体法粗看起来好像有一些抽象，其实理解起来很容易。即我们可以将任何一个业务过程划分成 3 个部分，实体，事件和说明。
描述一个简单的事实：“小明开车去学校上学”。以这个业务事实为例，我们可以把“小明”，“学校”看成是一个实体， “上学”描述的是一个业务过程，我们在这里可以抽象为一个具体“事件”，而“开车去”则可以看成是事件“上学”的一个说明。
 
### 应用场景
- **ER模型是数据库设计的理论基础，当前几乎所有的OLTP系统设计都采用ER模型建模的方式**。
- Bill Inom提出的数仓理论，推荐采用ER关系模型进行建模。
- BI架构提出分层架构，数仓底层ods、dwd也多采用ER关系模型进行设计。
> 由于实体建模法，能够很轻松的实现业务模型的划分，因此，在业务建模阶段和领域概念建模阶段，实体建模法有着广泛的应用。

### 业务归纳
> 使用的抽象归纳方法其实很简单，任何业务可以看成 3 个部分：
1. 实体，主要指领域模型中特定的概念主体，指发生业务关系的对象
2. 事件，主要指概念主体之间完成一次业务流程的过程，特指特定的业务过程
3. 说明，主要是针对实体和事件的特殊说明

## 维度建模
### 概念和背景
> 维度建模源自数据集市，主要面向分析场景。RalphKimball推崇数据集市的集合为数据仓库，同时也提出了对数据集市的维度建模，将数据仓库中的表划分为事实表、维度表两种类型。

- 般也称之为星型结构建模，有时也加入一些雪花模型在里面。**维度建模是一种面向用户需求的、容易理解的、访问效率高的建模方法**
> 维度模型通常以一种被称为星型模式的方式构建。所谓星型模式，就是以一个事实表为中心，周围环绕着多个维度表。还有一种模式叫做雪花模式，是对维度做进一
> 星型模型做OLAP分析很方便
- 维度建模法的另外一个优点是，维度建模非常直观，紧紧围绕着业务模型，**可以直观的反映出业务模型中的业务问题**。不需要经过特别的抽象处理，即可以完成维度建模。这一点也是维度建模的优势。
- 维度是描述事实的角度，如日期、商品、地址等，事实是要度量的指标，如用户数、销售额等

### 为什么选择维度建模

#### 适配大数据的处理方式
#### 自下而上的建设现状
- 表已经存在，业务已经开发完毕，需求直接提过来了
#### 简单的模型 使用简单

### 分层和建模的关系
#### 明细层的范式建模
- 明细层采用传统的三范式关系模型。这一层次的数据模型要将业务过程描述清楚，将源数据（即业务系统）中隐含的、有歧义的概念进行清晰化，如活跃用户、VIP用户等。该层次的数据模型追求的目标是灵活地表达业务过程，要保证数据一致性、唯一性、正确性，以尽量少的代价与源数据保持数据同步，同时该层次的数据模型不建议开给不懂技术的业务人员直接使用，因此，采用关系型的三范式模型是最佳的选择。

#### 集市层的维度模型
- 集市层是按照业务主题、分主题构建出来的、面向特定部门或人员的数据集合，该层次的数据模型会开放给业务人员使用，进行数据挖掘及业务分析。由于业务员多数不懂数据库技术，缺少将业务需求转换为关系型数据结构的逻辑思维，更写不出复杂的SQL语句，因此，越简单的数据模型，越能被他们所接受，因此，这个层次所构建出来的数据模型，要按照业务过程进行组织，每个事实表代表一个独立的业务过程，事实表之间不存在直接的依赖关系，这样业务人员可以很容易地将分析需求对应到事实表上，利用工具或手工写出简单的SQL，将统计数据提取出来进行分析。


### 事实表
- 在ER模型中抽象出了有**实体、关系、属性**三种类别，**在现实世界中，每一个操作型事件，基本都是发生在实体之间的**，伴随着这种操作事件的发生，会产生**可度量的值**，而**这个过程就产生了一个事实表，存储了每一个可度量的事件**
- 可以认为是**主题的各个度量**
"昨天早上张三在京东花费200元买了一个皮包",这里以购买为主题(过程)的话，200就是针对该过程(主题)的一个度量，所以可以看出事实表示包含了维度表的主键，这个时候就需要通过join 进行关联，**在关联的过程中引入了雪花模型和星型模型以及星座模型**
- **事实表的特点就是增长迅速，且主要以数值进行记录**

#### 事实表的度量
- 可加
> 可以进行任意维度下的累加
- 半可加
> 每个学生的各个科目的成绩是可加的，但是全班的各个科目进行累加是没有意义的
- 不可加
- 需要注意不可加的在任何情况下都是不可加的，比例或者比率是只针对该行有意义，直接累加无意义

#### 一致性
##### 内部一致性
- 在同一个表中，所有记录的粒度和维度是一致的，每一列的单位、枚举值都是一样的
> 想想掌门的学生课程表，少儿和一对一属于两个业务线，放在一起之后字段都无法统一

> 例如 订单表中的金额的单位要进行统一，不能有的是分，有的是元

##### 表与表之间的一致性
- 在进行多表合并的时候要保证彼此之间是针对同一事实的计算，是在同一粒度和维度之下的
> 订单表和退单表进行对冲，我们需要保证维度是一致的，例如可以设置订单表的金额是正的，退单表的金额是负的，然后合并分组求和即可。

#### 事实表设计原则
1. 尽可能包括所有业务过程相关的事实
2. 只选择与业务过程相关的事实
3. 分解不可加事实为可加的组件
4. 选择维度和事实之前必须先声明粒度
5. 在同一个事实表中不可以有多重不同粒度的事实
6. 事实的单位要保持一致
7. 对事实的null值要处理
8. 使用退化维提高事实表的易用性

#### 事实表的分类
##### 事务事实表
- 记录特定事件的事实，如销售。
##### 快照事实表
- 记录给定时间点的事实，如月底账户余额。

##### 累积事实表
- 记录给定时间点的聚合事实，如当月的总的销售金额。一般需要给事实表设计一个代理键作为每行记录的唯一标识。代理键是由系统生成的主键，它不是应用数据，没有业务含义，对用户来说是透明的。
- 累积快照事实表和周期快照事实表有些相似之处，它们存储的都是事务数据的快照信息。但是它们之间也有着很大的不同，周期快照事实表记录的确定的周期的数据，而累积快照事实表记录的不确定的周期的数据。 
- 累积快照事实表代表的是完全覆盖一个事务或产品的生命周期的时间跨度，它通常具有多个日期字段，用来记录整个生命周期中的关键时间点。

### 维度表
- 维度，顾名思义，**看待事物的角度，可以认为是主题的各个属性**，可以认为是对分析主题所属类型的描述。
> "昨天早上张三在京东花费200元买了一个皮包",这里分析时间维度、地点维度(京东)、商品维度(皮包)
- 维度表一般为**单一主键**，在ER模型中，实体为客观存在的事务，会带有自己的描述性属性，属性一般为文本性、描述性的，这些描述被称为维度。
- 维度建模的核心是**数据可以抽象为事实和维度**，维度即观察事物的角度，事实某一粒度下的度量词

#### 维度表设计
- 维度的设计过程就是确定维度属性的过程，如何生成维度属性，以及所生成维度属性的优劣，决定了维度是用的方便性，成为数据仓库易用性的关键。
- **数据仓库的能力直接与维度属性的质量和深度成正比**。

#### 维度表基本设计方法
##### 选择维度
- 第一步：选择维度(在已有的维度上进行添加)或者新建维度。作为维度建模的核心，**在企业级数据仓库中，必须保证维度的唯一性。以商品维度为例，有且只有一个维度定义**。

##### 确定主维表
- 第二步：确定主维表。此处的主维表一般是ODS表，直接与业务系统同步。
> 例如多个业务线都用自己的用户表，那这个时候主维表可能就是多个ods 表 

##### 确定相关维表
- 第三步：确定相关维表。数据仓库是业务源系统的数据整合，不同业务系统或者同一业务系统中的表之间存在关联性，根据业务系统的梳理，确定哪些表和主维表存在关联关系，并选择其中的某些表用于生成维度属性。
> 以商品维度为例，根据业务逻辑的梳理，可以得到商品与类目、sku、买家、卖家、店铺等维度**存在的关联关系**

##### 确定维度属性
- 第四步：确定维度属性。本步骤主要包括两个阶段，其中一个阶段是从主维表中选择维度属性或生成新的维度属性；第二个阶段是从相关维表中选择维度属性或者生成新的维度属性。以商品维度为例，从主维表和类目、sku、卖家、店铺等相关维表中**选择维度属性或者生成新的维度属性**

#### 缓慢变化维度表
- 维度表里面的数据并非是始终不变的，总会随着时间发生变化。
- 维度建模的数据仓库中，有一个概念叫Slowly Changing Dimensions，中文一般翻译成“缓慢变化维”，经常被简写为SCD。缓慢变化维的提出是因为在现实世界中，维度的属性并不是静态的，它会随着时间的流失发生缓慢的变化。
- 这种随时间发生变化的维度我们一般称之为缓慢变化维度，并且把处理维度表的历史变化信息的问题称为处理缓慢变化维的问题，有时也简称为处理SCD的问题。

##### 重写维度值
- 采用此种方式，不保留历史数据（简单来说就是更新相关的维度字段）

##### 拉链表
- 保存维度变化

##### 忽略
- 像一些数据，可以忽略修改

##### 快照维度
- 此种方式比较暴力，每天保留全量维度属性的快照数据，自然键及日期键作为事实表的外键。
- 此方式依托的是当前存储成本远低于计算成本，以空间换时间的理念。

#### 维度规范化
- 与关系模型类似，维度也可以进行规范化。对维度的规范化（又叫雪花化），可以去除冗余属性，是对非规范化维度做的规范化处理
- 一个非规范化维度对应一个维度表，**规范化后，一个维度会对应多个维度表，维度被严格地以子维度的形式连接在一起**。
- 实际上，在很多情况下，维度规范化后的结构**等同于一个低范式级别的关系型结构**。

##### 不规范化的原因
- 规范化会增加表的数量，使结构更复杂。
- 不可避免的多表连接，使查询更复杂。
- 不适合使用位图索引。
- 查询性能原因。分析型查询需要聚合计算或检索很多维度值，此时第三范式的数据库会遭遇性能问题。如果需要的仅仅是操作型报表，可以使用第三范式，因为操作型系统的用户需要看到更细节的数据。

#### 建议
- 尽可能生成丰富的维度属性；
- 尽可能多的给出包括一些富有意义的文字描述；
- 区分数值型属性和事实；
- 尽可能沉淀出通用的维度属性。

### 模型实现
- 模型主要是源于维度建模过程中，需要对维度表和事实表进行关联的设计。
- 星型模型和雪花模型的**主要区别在于对维度表的拆分**，**对于雪花模型，维度表的设计更加规范，一般符合3NF**；而**星型模型，一般采用降维的操作，利用冗余来避免模型过于复杂，提高易用性和分析效率**。

![image](97754E015F1E4D56981C6458BE1B698A)
#### 雪花模型
- 星形模式中的维表相对雪花模式来说要大，而且不满足规范化设计。
- 雪花模型相当于将星形模式的大维表拆分成小维表，满足了规范化设计。然而这种模式在实际应用中很少见，因为这样做会导致开发难度增大，而数据冗余问题在数据仓库里并不严重
- 可以认为雪花模型是星型模型的一个扩展，每个维度表可以继续向外扩展，连接多个子维度。

![image](E5EE03DD106F49F2ACE0EB5E751C2D37)

#### 星型模型
> 核心是**一个事实表及多个非正规化描述的维度表**组成，维度表之间是没有关联的，维度表是直接关联到事实表上的
- 只有当维度表极大，存储空间是个问题时，才考虑雪花型维度，简而言之，最好就用星型维度即可

![image](246E01B16D424438A25DCCD45D886737)

#### 星座模型
![image](D7C4975ECC40406B8604F687F7404CD2)
- 前面介绍的两种维度建模方法都是多维表对应单事实表，但在很多时候维度空间内的事实表不止一个，而一个维表也可能被多个事实表用到。在业务发展后期，绝大部分维度建模都采用的是星座模式。
- 可以认为是多个事实表的关联或者是星型模型的关联，其实到了业务发展后期都是星座模型

### 应用场景
- 维度建模**是面向分析场景而生**，针对分析场景构建数仓模型，重点关注快速、灵活的解决分析需求，同时能够提供大规模数据的快速响应性能。
- 针对性强，主要应用于数据仓库构建和OLAP引擎底层数据模型


#### 优点
- 方便使用，模型简单
- 适合大数据下的处理操作(其实就是shuffle)
- 适合OLAP操作(上钻下钻)
- 维度建模非常直观，紧紧围绕着业务模型，可以直观的反映出业务模型中的业务问题。不需要经过特别的抽象处理，即可以完成维度建模。
- 可扩展，维度模型是可扩展的。由于维度模型允许数据冗余，因此当向一个维度表或事实表中添加字段时，不会像关系模型那样产生巨大的影响，带来的结果就是更容易容纳不可预料的新增数据。

> 简单的证明
![image](B888B3C8A50C454291E62BCFD0E710AF)
![image](F14B79B6A9E54AF79268949364D6884D)


#### 缺点
- 数据冗余，维度补全后造成的数据浪费
- 灵活性差，维度变化造成的数据更新量大(例如刷数据的时候，需要刷大量的表)
- 与典型的范式理论差异很大
> 既然如此为什么还要使用范式建模呢，其实和我们使用的工具有关系

- 由于在构建星型模式之前需要进行大量的数据预处理，因此会导致大量的数据处理工作。而且，当业务发生变化，需要重新进行维度的定义时，往往需要重新进行维度数据的预处理。而在这些与处理过程中，往往会导致大量的数据冗余。

- 如果只是依靠单纯的维度建模，不能保证数据来源的一致性和准确性，**而且在数据仓库的底层，不是特别适用于维度建模的方法**。
- 维度建模的领域主要适用与数据集市层，它的最大的作用其实是为了解决数据仓库建模中的性能问题。维度建模很难能够提供一个完整地描述真实业务实体之间的复杂关系的抽象方法

## Data Vault模型
## Anchor模型
